# Dockerfile.dev - Infrastructure Development Dockerfile
# Combines server, prisma, and app services for development

# Multi-stage build for the infrastructure
FROM node:20-alpine AS app-builder

# Install system dependencies for app
RUN apk add --no-cache \
    libc6-compat \
    git \
    bash \
    curl

# Enable Corepack and pnpm
RUN corepack enable && corepack prepare pnpm@10.28.1 --activate

# Set working directory
WORKDIR /app

# Copy app package files
COPY app/package.json app/pnpm-lock.yaml ./

# Install app dependencies
RUN pnpm install --force

# Copy app source
COPY app .

# Build the app for development
RUN pnpm dev --build

# Go stage for server
FROM golang:1.25.5-alpine AS server-builder

# Set working directory
WORKDIR /server

# Copy server go.mod and go.sum
COPY server/go.mod server/go.sum ./

# Download dependencies
RUN go mod download

# Copy server source
COPY server .

# Build the server
RUN go build -o aether-server main.go

# Final stage
FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache \
    libc6-compat \
    git \
    bash \
    curl \
    ca-certificates

# Enable Corepack and pnpm
RUN corepack enable && corepack prepare pnpm@10.28.1 --activate

# Set working directory
WORKDIR /app

# Copy from app builder
COPY --from=app-builder /app/node_modules ./node_modules
COPY --from=app-builder /app/.next ./.next
COPY --from=app-builder /app/public ./public

# Copy from server builder
COPY --from=server-builder /server/aether-server /aether-server

# Copy app source
COPY app .

# Environment variables
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME=0.0.0.0
ENV CHOKIDAR_USEPOLLING=true

# Expose ports (internal container ports)
EXPOSE 3000 8080

# Start both services
CMD ["sh", "-c", "pnpm dev --hostname 0.0.0.0 --port 3000 & /aether-server"]