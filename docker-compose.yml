version: '3.8'

services:

  postgres:
  image: postgres:16
  container_name: ${COMPOSE_PROJECT_NAME:-aether}-postgres
  environment:
    POSTGRES_DB: ${POSTGRES_DB:-aether_identity}
    POSTGRES_USER: ${POSTGRES_USER:-postgres}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ${BACKUP_DIR:-./backups}:/backups
    - ${INIT_SCRIPTS_DIR:-./init-scripts}:/docker-entrypoint-initdb.d
  ports:
    - "${POSTGRES_PORT:-5432}:5432"
  restart: ${RESTART_POLICY:-no-restart}
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-aether_identity}"]
    interval: ${POSTGRES_HEALTH_CHECK_INTERVAL:-10s}
    timeout: ${POSTGRES_HEALTH_CHECK_TIMEOUT:-5s}
    retries: ${POSTGRES_HEALTH_CHECK_RETRIES:-10}
    start_period: ${POSTGRES_HEALTH_CHECK_START_PERIOD:-30s}
  networks:
    - aether-network

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-backend
    environment:
      NODE_ENV: ${NODE_ENV}
      DATABASE_PROVIDER: ${DATABASE_PROVIDER}
      DATABASE_URL: ${DATABASE_URL}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      API_CORS_ORIGINS: ${API_CORS_ORIGINS}
      BACKUP_ENABLED: ${BACKUP_ENABLED}
      AUTO_BACKUP_BEFORE_MIGRATION: ${AUTO_BACKUP_BEFORE_MIGRATION}
      DISABLE_DB_RESET: ${DISABLE_DB_RESET}
      DISABLE_SEED_OVERRIDE: ${DISABLE_SEED_OVERRIDE}
      REQUIRE_MIGRATION_BACKUP: ${REQUIRE_MIGRATION_BACKUP}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: ${LOG_FILE}
      API_DOCS_ENABLED: ${API_DOCS_ENABLED}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED}
    volumes:
      - ${BACKUP_DIR}:/app/backups
      - ${LOGS_DIR}:/app/logs
      - ${DATA_DIR}:/app/data
    ports:
      - "${BACKEND_PORT}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: ${RESTART_POLICY}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: ${BACKEND_HEALTH_CHECK_INTERVAL}
      timeout: ${BACKEND_HEALTH_CHECK_TIMEOUT}
      retries: ${BACKEND_HEALTH_CHECK_RETRIES}
      start_period: ${BACKEND_HEALTH_CHECK_START_PERIOD}
    networks:
      - aether-network

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-frontend
    environment:
      NODE_ENV: ${NODE_ENV}
      BACKEND_URL: http://backend:8080
      API_BASE_URL: http://backend:8080/api/v1
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED}
    ports:
      - "${FRONTEND_PORT}:3000"
    depends_on:
      backend:
        condition: service_healthy
    restart: ${RESTART_POLICY}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: ${FRONTEND_HEALTH_CHECK_INTERVAL}
      timeout: ${FRONTEND_HEALTH_CHECK_TIMEOUT}
      retries: ${FRONTEND_HEALTH_CHECK_RETRIES}
      start_period: ${FRONTEND_HEALTH_CHECK_START_PERIOD}
    networks:
      - aether-network


volumes:
  postgres_data:

networks:
  aether-network:
    driver: bridge