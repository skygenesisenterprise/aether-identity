version: '3.8'

##################################################
# Services
##################################################
services:
  # --------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-aether}-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-aether_identity}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ${BACKUP_DIR:-./backups}:/backups
      - ${INIT_SCRIPTS_DIR:-./init-scripts}:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-aether_identity}"]
      interval: ${POSTGRES_HEALTH_CHECK_INTERVAL:-10s}
      timeout: ${POSTGRES_HEALTH_CHECK_TIMEOUT:-5s}
      retries: ${POSTGRES_HEALTH_CHECK_RETRIES:-10}
      start_period: ${POSTGRES_HEALTH_CHECK_START_PERIOD:-30s}
    networks:
      - aether-network

  # --------------------------------------------
  # Backend API
  # --------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-production}
        DATABASE_PROVIDER: ${DATABASE_PROVIDER:-postgresql}
    container_name: ${COMPOSE_PROJECT_NAME:-aether}-backend
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_PROVIDER: ${DATABASE_PROVIDER:-postgresql}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:password@postgres:5432/aether_identity}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-aether_identity}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      API_CORS_ORIGINS: ${API_CORS_ORIGINS}
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      AUTO_BACKUP_BEFORE_MIGRATION: ${AUTO_BACKUP_BEFORE_MIGRATION:-true}
      DISABLE_DB_RESET: ${DISABLE_DB_RESET:-true}
      DISABLE_SEED_OVERRIDE: ${DISABLE_SEED_OVERRIDE:-true}
      REQUIRE_MIGRATION_BACKUP: ${REQUIRE_MIGRATION_BACKUP:-true}
      LOG_LEVEL: ${LOG_LEVEL:-warn}
      LOG_FILE: ${LOG_FILE:-logs/api.log}
      API_DOCS_ENABLED: ${API_DOCS_ENABLED:-false}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}
    volumes:
      - ${BACKUP_DIR:-./backups}:/app/backups
      - ${LOGS_DIR:-./logs}:/app/logs
      - ${DATA_DIR:-./data}:/app/data
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: ${BACKEND_HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${BACKEND_HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${BACKEND_HEALTH_CHECK_RETRIES:-3}
      start_period: ${BACKEND_HEALTH_CHECK_START_PERIOD:-60s}
    networks:
      - aether-network

  # --------------------------------------------
  # Frontend
  # --------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-production}
    container_name: ${COMPOSE_PROJECT_NAME:-aether}-frontend
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      BACKEND_URL: http://backend:8080
      API_BASE_URL: http://backend:8080
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: ${FRONTEND_HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${FRONTEND_HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${FRONTEND_HEALTH_CHECK_RETRIES:-3}
      start_period: ${FRONTEND_HEALTH_CHECK_START_PERIOD:-30s}
    networks:
      - aether-network

##################################################
# Volumes
##################################################
volumes:
  postgres_data:
    driver: local

##################################################
# Networks
##################################################
networks:
  aether-network:
    driver: bridge